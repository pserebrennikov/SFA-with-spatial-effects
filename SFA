library('openxlsx')
library('dplyr')
library('ggplot2')
library('mice')
library('VIM')
library('frontier')


df_2017.for_sfa <- read.xlsx(xlsxFile = '2017_for_sfa_geo.xlsx')

# present data as numeric
for (i in 4:9) 
  df_2017.for_sfa[,i] <- as.numeric(as.character(df_2017.for_sfa[,i])
  

outlier <- function(x) {
  qnt <- quantile(x, probs=c(.25,.75), na.rm=TRUE)
  caps <- quantile(x, probs=c(.05,.95), na.rm=TRUE)
  H <- 3 * IQR(x, na.rm = T)
  y <- x
  y[x < (qnt[1] - H)] <- caps[1]
  y[x > (qnt[2] + H)] <- caps[2]
  return(y)
}


for (i in 4:9) 
  df_2017.for_sfa[,i] <- outlier(df_2017.for_sfa[,i])
 
replace_zero <- function(vec){
  
  for(i in 1:length(vec)){
    if(vec[i] == 0)
      vec[i] = 1e-04
  }
  return(vec)
}

for (i in 4:9) 
  df_2017.for_sfa[,i] <- replace_zero(df_2017.for_sfa[,i])
    
# sfa
X <- with(df_2017.for_sfa, 
          cbind(mean_EGE = `Средний.балл.ЕГЭ.студентов..принятых.по.результатам.ЕГЭ.на.обучение.по.очной.форме.по.программам.бакалавриата.и.специалитета.за.счет.средств.соответствующих.бюджетов.бюджетной.системы.РФ` / Доходы.вуза.из.всех.источников,
                nums_of_NPR = Общая.численность.НПР / Доходы.вуза.из.всех.источников,
                Nums_of_publications = Общее.количество.публикаций,
                Priv_cont = Приведенный.контингент,
                NIOKR = `Общий.объем.научно.исследовательских.и.опытно.конструкторских.работ..далее...НИОКР`,
                Income_of_univ = Доходы.вуза.из.всех.источников))
                
                
impute_X <- mice(X)
X <- complete(impute_X,1)

sfa <- sfa(data = X, -log(Income_of_univ) ~ log(mean_EGE) + log(nums_of_NPR) + 
                                               log(Nums_of_publications) + log(Priv_cont) +
                                               log(NIOKR))
summary(sfa)
ggplot(as.data.frame(efficiencies(sfa)), fill = "grey", color = "black") + 
  geom_histogram(aes(x = efficiencies(sfa))) + ggtitle('Distribution of effectiency`s estimations')
  
  
### change normalizing input

X_1 <- with(df_2017.for_sfa, 
          cbind(mean_EGE = `Средний.балл.ЕГЭ.студентов..принятых.по.результатам.ЕГЭ.на.обучение.по.очной.форме.по.программам.бакалавриата.и.специалитета.за.счет.средств.соответствующих.бюджетов.бюджетной.системы.РФ` / Общая.численность.НПР,
                Income_of_univ = Доходы.вуза.из.всех.источников / Общая.численность.НПР,
                Nums_of_publications = Общее.количество.публикаций,
                Priv_cont = Приведенный.контингент,
                NIOKR = `Общий.объем.научно.исследовательских.и.опытно.конструкторских.работ..далее...НИОКР`,
                Nums_of_NPR = Общая.численность.НПР))

impute_X1 <- mice(X_1)
X_1 <- complete(impute_X1,1)

sfa_1 <- sfa(data = X_1, -log(Nums_of_NPR) ~ log(mean_EGE) + log(Income_of_univ) + 
                log(Nums_of_publications) + log(Priv_cont) +
                log(NIOKR))

summary(sfa_1)
ggplot(as.data.frame(efficiencies(sfa_1)), fill = "grey", color = "black") + 
  geom_histogram(aes(x = efficiencies(sfa_1))) + ggtitle('Distribution of effectiency`s estimations')

### change normalizing input

X_2 <- with(df_2017.for_sfa, 
            cbind(Nums_of_NPR = Общая.численность.НПР / `Средний.балл.ЕГЭ.студентов..принятых.по.результатам.ЕГЭ.на.обучение.по.очной.форме.по.программам.бакалавриата.и.специалитета.за.счет.средств.соответствующих.бюджетов.бюджетной.системы.РФ`,
                  Income_of_univ = Доходы.вуза.из.всех.источников / `Средний.балл.ЕГЭ.студентов..принятых.по.результатам.ЕГЭ.на.обучение.по.очной.форме.по.программам.бакалавриата.и.специалитета.за.счет.средств.соответствующих.бюджетов.бюджетной.системы.РФ`,
                  Nums_of_publications = Общее.количество.публикаций,
                  Priv_cont = Приведенный.контингент,
                  NIOKR = `Общий.объем.научно.исследовательских.и.опытно.конструкторских.работ..далее...НИОКР`,
                  mean_EGE = `Средний.балл.ЕГЭ.студентов..принятых.по.результатам.ЕГЭ.на.обучение.по.очной.форме.по.программам.бакалавриата.и.специалитета.за.счет.средств.соответствующих.бюджетов.бюджетной.системы.РФ`))

impute_X2 <- mice(X_2)
X_2 <- complete(impute_X2,1)

sfa_2 <- sfa(data = X_2, -log(mean_EGE) ~ log(Nums_of_NPR) + log(Income_of_univ) + 
                  log(Nums_of_publications) + log(Priv_cont) +
                  log(NIOKR))
summary(sfa_2)
ggplot(as.data.frame(efficiencies(sfa_2)), fill = "grey", color = "black") + 
  geom_histogram(aes(x = efficiencies(sfa_2))) + ggtitle('Distribution of effectiency`s estimations')
